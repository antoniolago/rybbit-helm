name: Publish Helm Chart

on:
  push:
    tags:
    - 'v*'

env:
  HARBOR_REGISTRY: harbor.lag0.com.br
  GHCR_REGISTRY: ghcr.io
  KIND_CLUSTER_NAME: rybbit-ci-test
  NAMESPACE: rybbit
  RELEASE_NAME: rybbit

jobs:
  lint:
    name: Lint Helm Chart
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Add Helm repositories
        run: |
          helm repo add cnpg https://cloudnative-pg.github.io/charts
          helm repo add altinity https://helm.altinity.com/
          helm repo update

      - name: Run Helm lint
        run: helm lint .

      - name: Run chart-testing lint
        uses: helm/chart-testing-action@v2
        with:
          version: v3.10.0

      - name: Lint chart
        run: ct lint --chart-dirs . --charts . --validate-maintainers=false

  template:
    name: Template Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Update dependencies
        run: helm dependency update

      - name: Template chart
        run: helm template test-release . --namespace test --debug

      - name: Template with custom values
        run: |
          helm template test-release . \
            --namespace test \
            --set backend.replicaCount=2 \
            --set client.replicaCount=2 \
            --set postgresql.cluster.instances=3 \
            --debug

  integration-test:
    name: Integration Test (KinD)
    runs-on: ubuntu-latest
    needs: [lint, template]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Create KinD cluster
        uses: helm/kind-action@v1
        with:
          cluster_name: ${{ env.KIND_CLUSTER_NAME }}
          config: |
            kind: Cluster
            apiVersion: kind.x-k8s.io/v1alpha4
            nodes:
            - role: control-plane
            - role: worker

      - name: Install CloudNativePG Operator
        run: |
          helm repo add cnpg https://cloudnative-pg.github.io/charts
          helm repo update
          helm install cnpg cnpg/cloudnative-pg \
            --namespace cnpg-system \
            --create-namespace \
            --wait \
            --timeout 300s

      - name: Update Helm dependencies
        run: helm dependency update

      - name: Install Rybbit chart
        run: |
          IMAGE_TAG="latest"
          
          helm upgrade --install ${{ env.RELEASE_NAME }} . \
            --namespace ${{ env.NAMESPACE }} \
            --create-namespace \
            --set backend.image.tag="${IMAGE_TAG}" \
            --set client.image.tag="${IMAGE_TAG}" \
            --set postgresql.cluster.instances=1 \
            --set clickhouse.clickhouse.replicasCount=1 \
            --set clickhouse.keeper.replicaCount=1 \
            --set backend.replicaCount=1 \
            --set client.replicaCount=1 \
            --set global.podDisruptionBudget.enabled=false \
            --wait \
            --timeout 600s

      - name: Wait for pods
        run: |
          echo "Waiting for all pods to be ready..."
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/instance=${{ env.RELEASE_NAME }} \
            -n ${{ env.NAMESPACE }} \
            --timeout=300s || true
          
          kubectl get pods -n ${{ env.NAMESPACE }}

      - name: Check deployments
        run: |
          kubectl get deployments -n ${{ env.NAMESPACE }}
          
          BACKEND_READY=$(kubectl get deployment ${{ env.RELEASE_NAME }}-backend \
            -n ${{ env.NAMESPACE }} \
            -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
          
          CLIENT_READY=$(kubectl get deployment ${{ env.RELEASE_NAME }}-client \
            -n ${{ env.NAMESPACE }} \
            -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
          
          echo "Backend ready replicas: $BACKEND_READY"
          echo "Client ready replicas: $CLIENT_READY"

      - name: Show pod logs on failure
        if: failure()
        run: |
          echo "=== Backend logs ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app.kubernetes.io/component=backend --tail=100 || true
          
          echo "=== Client logs ==="
          kubectl logs -n ${{ env.NAMESPACE }} -l app.kubernetes.io/component=client --tail=100 || true
          
          echo "=== Pod descriptions ==="
          kubectl describe pods -n ${{ env.NAMESPACE }}

      - name: Cleanup
        if: always()
        run: |
          helm uninstall ${{ env.RELEASE_NAME }} -n ${{ env.NAMESPACE }} || true
          kubectl delete namespace ${{ env.NAMESPACE }} --ignore-not-found || true

  publish:
    name: Publish to Registries
    runs-on: ubuntu-latest
    needs: [lint, template, integration-test]
    permissions:
      contents: read
      packages: write
    steps:
    - name: Set version from tag
      run: |
        ref=${GITHUB_REF##*/}
        echo "VERSION=${ref#v}" >> $GITHUB_ENV
        echo "Publishing version: ${ref#v}"

    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Helm
      uses: azure/setup-helm@v3
      with:
        version: v3.12.3

    - name: Update dependencies
      run: |
        echo "=== Updating dependencies ==="
        helm dependency update .
        echo "✓ Dependencies updated successfully"

    - name: Package Helm Chart
      run: |
        echo "=== Packaging chart version ${{ env.VERSION }} ==="
        helm package --version ${{ env.VERSION }} .
        echo "✓ Chart packaged successfully"

    - name: Login to Harbor Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.HARBOR_REGISTRY }}
        username: ${{ secrets.REGISTRY_USERNAME }}
        password: ${{ secrets.REGISTRY_PASSWORD }}

    - name: Push to Harbor Registry
      run: |
        echo "=== Pushing to Harbor OCI registry ===" 
        helm push rybbit-${{ env.VERSION }}.tgz oci://${{ env.HARBOR_REGISTRY }}/library
        echo "✓ Chart pushed successfully to Harbor"

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.GHCR_REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Push to GitHub Container Registry (ghcr.io)
      run: |
        echo "=== Pushing to GitHub Container Registry (ghcr.io) ===" 
        helm push rybbit-${{ env.VERSION }}.tgz oci://${{ env.GHCR_REGISTRY }}/${{ github.repository_owner }}
        echo "✓ Chart pushed successfully to ghcr.io"
